# 合宙 IOT 通用报文协议 AirProtcl -- 1.0

# 一、背景

合宙的设备，需要一个通用的报文协议，使得合宙的设备，能够按照这个通用协议，把设备采集的各种数据上报到合宙云平台做记录。

```
同时，该协议，也能够支持接收下发的指令。

该协议必须是基于连接的承载，可以是 TCP，也可以是 MQTT，以方便进行鉴权。

协议采用二进制方式，节约通信流量，降低功耗。

同时，该协议要足够简单，看完报文协议后，无需查阅，就可以理解报文的含义。

上行和下行，采用同样的报文格式。
```

# 二、协议报文详解

```
报文分为消息头和消息体两部分。

消息头只有一个，在报文开头，固定12个字节，分为设备ID，消息长度，版本标志三个字段。

消息体可以有多个，采用TLV的形式。

除了特殊约定外，报文的各个字节采用大端对齐的方式。
```

## 2.1 消息头

消息头一共 16 字节。

1， 设备 ID - 8 字节

其中第一个字节，代表设备类型，4G，WiFi，BLE，等；

剩余 7 字节为设备 ID，可以是 IMEI，也可以是 MAC， 也可以是 Chip ID，不做特殊约定。

设备 ID 采用 BCD 编码方式。

设备 ID 长度不足 7 字节的，自动在高位补 0.

2，流水号 - 2 字节

3，消息长度 - 2 字节

```
从版本标识开始的消息长度，最长不能大于 1400字节。
```

4，消息标识-4 字节

```
用来做协议和消息约定的32个bit。

bit0-3： 协议版本号；

bit4：    是否需要回复

bit5：    是否携带鉴权 key

其余26个bit 为0.
```

## 2.2 消息体

消息体有多个 TLV 组成： T-字段类型，L-字段长度，V-字段取值，可以任意多个 TLV， 只要消息长度不超过 1400 字节即可。

1， 字段类型 - 2 字节

前面 12 个 bit， 代表字段含义，比如温度，湿度，转速，工作或者停止，等等；

后面 4bit，代表数据类型（整数，浮点，bool，ascii，binary）

2， 长度 - 2 字节

字段取值的长度

3， 字段值

实际的值。

## 2.3 消息字段示例

<table>
<tr>
<td>字段<br/></td><td>**字段名**<br/></td><td>**长度**<br/></td><td>含义<br/></td></tr>
<tr>
<td>消息头<br/></td><td>设备ID<br/></td><td>8<br/></td><td>第一个字节，代表设备类型，4G，WiFi，BLE，等；<br/>剩余7字节为设备ID，可以是IMEI，也可以是MAC， 也可以是Chip ID，不做特殊约定。 <br/></td></tr>
<tr>
<td>消息头<br/></td><td>流水号<br/></td><td>2<br/></td><td><br/></td></tr>
<tr>
<td>消息头<br/></td><td>消息长度<br/></td><td>2<br/></td><td>从版本标识开始的消息长度，最长不能大于 1400字节。<br/></td></tr>
<tr>
<td>消息头<br/></td><td>消息标识<br/></td><td>4<br/></td><td>bit0-3： 协议版本号；<br/>bit4：    是否需要回复<br/>bit5：    是否携带鉴权 key<br/>其余26个bit 为0.<br/></td></tr>
<tr>
<td>认证key（可选）<br/></td><td>key<br/></td><td>64<br/></td><td>用于 UDP 报文的鉴权<br/></td></tr>
<tr>
<td>TLV1<br/></td><td>字段类型<br/></td><td>2<br/></td><td> 前面12个bit， 代表字段含义，比如温度，湿度，转速，工作或者停止，等等；<br/>   后面4bit，代表数据类型（整数，浮点，bool，ascii，binary）<br/></td></tr>
<tr>
<td>TLV1<br/></td><td>长度<br/></td><td>2<br/></td><td><br/></td></tr>
<tr>
<td>TLV1<br/></td><td>字段值<br/></td><td>N<br/></td><td><br/></td></tr>
<tr>
<td>TLV2<br/></td><td>字段类型<br/></td><td>2<br/></td><td><br/></td></tr>
<tr>
<td>TLV2<br/></td><td>长度<br/></td><td>2<br/></td><td><br/></td></tr>
<tr>
<td>TLV2<br/></td><td>字段值<br/></td><td>N<br/></td><td><br/></td></tr>
<tr>
<td>......<br/></td><td><br/></td><td><br/></td><td><br/></td></tr>
<tr>
<td><br/></td><td><br/></td><td><br/></td><td><br/></td></tr>
</table>

## 2.4 设备鉴权

在设备建立连接之前，需要发送鉴权消息。

鉴权的方式是，通过 TLV 传递用户的 key+IMEI(或者 MAC)+MUID，由服务器判断是否合法，如果不合法的话，服务器主动发起断链操作。

# 三、字段类型定义

字段类型一共 2 字节，分为两部分：  **字段含义和数据类型**，其中字段含义 12bit，数据类型 4bit。

## 3.1 数据类型

数据类型占用 4 个 bit，理论上支持 16 种数据类型。

0000 - 整数

0001 - 浮点数

0002 - 布尔值

0003 - ASCII 字符串

0004 - binary 字符串

0005 - UNICODE 字符串

## 3.2 字段含义

字段含义占用 12bit，理论上支持 4096 种字段含义。

其中，0 为预留值，1-128 为控制信令类型， 129-2048 为业务字段类型，2049-4096 为预留值。

### 3.2.1 控制信令类型

1 - 鉴权请求 - 上行

2 - 鉴权回复 - 下行

3 - 上报回应 - 下行，用于服务器对设备的上报的回应

4 - 控制回应 - 上行， 用于对服务器发送的控制命令的回应

### 3.2.2 业务字段类型

129 - 温度

130 - 湿度

131 - 高度

132 - 宽度

133 - 转速

134 - GNSS 经度

135 - GNSS 维度

136 - 行驶速度

137 - 最强的 4 颗 GNSS 微信的 4 个 CN

138 - 搜到的所有卫星数

139 - 可见卫星数

140 - 航向角

141 - 基站定位/GNSS 定位标识

142 - GNSS 芯片型号和固件版本号

150 - 电量（mV）

151 - 方向

152 - 颗粒数

153 - 时间

154 - 无意义数据

155 - 酸度

156 - 碱度

157 - 海拔

158 - 水位

159 - 驻留小区

160 - 驻留小区和临区

161 - Lua 核心库错误上报（用于 LuatOS 自动化测试）

162 - Lua 扩展卡错误上报（用于 LuatOS 自动化测试）

163 - Lua 业务错误上报（用于 LuatOS 自动化测试）

164 - 固件版本号

165 - 主控型号

170 - CPU 温度/环境温度

172 - GPIO 高低电平

173 - 开机原因

174 - 开机次数

175 - 休眠模式

176 - 定时唤醒间隔

177 - 设备入网的 IPV4/IPV6 标志

178 - 当前联网方式（4G/WiFi/以太网）

# 四、AirProtcl 和遥测的关系

遥测的目的是检测设备的 mobile 信息，证明设备还活着，还具备通信能力；

AirProtcl 协议，目的是合宙设备驱动的业务，都有被记录到数据库的机会。

# 五、支持的通信承载

## 5.1 TCP

TCP server 收到数据后，直接发起写入数据库动作。

TCP server 在接受了 socket 连接后，等待设备的鉴权请求，如果超时或者鉴权请求不通过，主动发起断链。

## 5.2 MQTT

### 5.2.1 MQTT 角色

```
有三个角色： 设备，Broker，ServClient。
```

## 5.2.2 MQTT 主题

```
ServClient 订阅所有主题，设备只订阅跟自己相关的主题。

设备的主题名字为： /AirPro/DeviceID/ServType
```

其中， AirPro 是固定字符串；

DeviceID 是设备的 ID， 内容和消息头的 设备 ID 相同；

ServType 包括两种：

（1）auth

（2）all

其中， auth 是指鉴权报文， all 是指所有其他报文。

## 5.2.3 鉴权

```
设备和Broker建立MQTT 连接后，首先设备要发起鉴权，Broker把鉴权请求转发给ServClient，ServClient审核后，回复鉴权通过或者鉴权失败。

如果回复的是鉴权失败，ServClent需要在10秒钟之内通知Broker，把发起鉴权的设备进行断链处理。

如果设备超时没有发起鉴权，ServClient也要通知Broker，把设备断链。
```

## 5.3 UDP

AirProtcl 当前不推荐 UDP 协议。

如果必须要用 UDP 的话，需要在消息标识的第 6 个 bit 设为 1， 并在消息头和 TLV 中间，放置 64 字节的 key。

服务器需要对每个 UDP 消息，进行 key 的合法性检查。

## 5.4 HTTP

AirProtcl 当前不支持 HTTP UDP 协议。

# 六、云端后台实现

## 6.1 云端后台记录

所有上报的数据，都记录到数据库

## 6.2 日志查询

提供 web 表单查询日志，并且可以导出到文件。

## 6.3 可视化展现

可视化展现，和数据存储做分离的实现。

## 6.4 API 查询

提供 web 后台的查询接口，后端和前端的实现可以分离。

# 七、应用

## 7.1 合宙内部挂测

### 7.1.1 合宙开发板

合宙的开发板，默认都使用一个 key， 上报当前的驻留小区，可以在后台查询日志。

### 7.1.2 合宙批量挂测

合宙的量产小板，用 airProtcl 批量挂测，做压力测试。

## 7.2 给客户的设备管理后台

客户可以用这个协议，搭建自己的后台；

也可以上报合宙的后台，合宙按照套餐收费。

合宙平台收费标准如下：

<table>
<tr>
<td><br/></td><td>免费版<br/></td><td>标准版<br/></td><td>VIP版<br/></td></tr>
<tr>
<td>年费<br/></td><td>0<br/></td><td>¥3000<br/></td><td>¥10000<br/></td></tr>
<tr>
<td>设备数<br/></td><td>3<br/></td><td>100(可扩容)<br/></td><td>1000(可扩容)<br/></td></tr>
<tr>
<td>每日上行消息限量<br/></td><td>1000<br/></td><td>1.5万<br/></td><td>150万<br/></td></tr>
<tr>
<td>数据保存时间<br/></td><td>7天<br/></td><td>6个月<br/></td><td>12个月<br/></td></tr>
<tr>
<td>API 云端对接<br/></td><td>不支持<br/></td><td>支持<br/></td><td>支持<br/></td></tr>
<tr>
<td>日志导出文件<br/></td><td>不支持<br/></td><td>支持<br/></td><td>支持<br/></td></tr>
<tr>
<td>二级用户<br/></td><td>不支持<br/></td><td>10<br/></td><td>100<br/></td></tr>
</table>

扩容费用：

<table>
<tr>
<td><br/></td><td>扩容量<br/></td><td>价格<br/></td></tr>
<tr>
<td>设备数扩容<br/></td><td>100<br/></td><td>500<br/></td></tr>
<tr>
<td>每日消息量扩容<br/></td><td>10万<br/></td><td>500<br/></td></tr>
<tr>
<td>二级用户<br/></td><td>100<br/></td><td>200<br/></td></tr>
<tr>
<td>数据存储<br/></td><td>1亿报文1年<br/></td><td>1000<br/></td></tr>
</table>

# 八，扩展库实现

exiot 扩展库， 调用 socket 核心库，mqtt 核心库，exnetif 扩展库。

扩展卡包含如下成员函数：

1，  init():  初始化参数，设备 ID，流水号初始化，指定协议版本，

2，  auth_req(), 携带对收到鉴权回复的回调，以及超时的回调。

3，  data_report(), 上报设备数据。
